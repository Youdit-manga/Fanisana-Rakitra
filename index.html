<!DOCTYPE html>
<html lang="mg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a365d">
    <title>FJKM Freiburg - Fanisana Rakitra</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #d69e2e;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #dd6b20;
            --bg-cream: #faf8f5;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-muted: #718096;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: var(--bg-cream);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin-bottom: 1.5rem;
        }

        .login-title {
            font-family: 'Playfair Display', serif;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
            text-align: center;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .pin-display {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .pin-dot {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            background: white;
        }

        .pin-dot.filled {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .pin-key {
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: var(--bg-cream);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pin-key:active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }

        .pin-key.danger { background: #fed7d7; color: var(--danger); }
        .pin-key.success { background: #c6f6d5; color: var(--success); }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .header-title h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
        }

        .header-title p { font-size: 0.8rem; opacity: 0.9; }

        .header-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .user-badge.admin {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--bg-white);
            border-bottom: 2px solid var(--border);
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
        }

        /* Container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 2rem;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .card-header {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header.success { background: var(--success); }
        .card-header.warning { background: var(--warning); }

        .card-body { padding: 1rem; }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Money Grid */
        .money-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }

        .money-row { display: contents; }

        .money-label {
            font-weight: 600;
            padding: 0.5rem;
            background: var(--bg-cream);
            border-radius: 8px;
            text-align: center;
            min-width: 70px;
        }

        .money-label.bill { background: #c6f6d5; color: #276749; }
        .money-label.coin { background: #feebc8; color: #c05621; }

        .money-input {
            width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }

        .money-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .money-total {
            font-weight: 700;
            color: var(--primary);
            text-align: right;
            min-width: 80px;
        }

        /* Total Section */
        .total-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin: 1rem 0;
        }

        .total-label { font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .total-amount {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
        }

        /* Signature Section */
        .signature-section { margin-bottom: 1.5rem; }

        .signature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .signature-name { font-weight: 600; color: var(--primary); }

        .signature-clear {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .signature-pad {
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: #fafafa;
            touch-action: none;
            cursor: crosshair;
            width: 100%;
            height: 80px;
        }

        .signature-pad.signed {
            border-color: var(--success);
            border-style: solid;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-block { width: 100%; }
        .btn:active { transform: scale(0.98); }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* History List */
        .history-item {
            background: var(--bg-cream);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--success);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .history-date {
            font-weight: 600;
            color: var(--primary);
        }

        .history-amount {
            font-weight: 700;
            color: var(--success);
            font-size: 1.1rem;
        }

        .history-category {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .history-people {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* User List */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-cream);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .user-info { display: flex; align-items: center; gap: 0.5rem; }

        .user-role {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--primary);
            color: white;
        }

        .user-role.admin { background: var(--accent); color: var(--primary); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { font-size: 1.1rem; }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body { padding: 1rem; }

        /* Detail View */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-muted); }
        .detail-value { font-weight: 600; }

        .signature-preview {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background: #fafafa;
        }

        .signature-preview img {
            max-width: 100%;
            height: 60px;
            object-fit: contain;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }

        /* Responsive */
        @media (max-width: 400px) {
            .money-label { min-width: 60px; font-size: 0.9rem; }
            .money-input { width: 60px; }
            .money-total { min-width: 70px; font-size: 0.9rem; }
            .nav-tab { font-size: 0.8rem; padding: 0.6rem 0.4rem; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-logo">‚õ™</div>
        <h1 class="login-title">FJKM Freiburg Fiderana</h1>
        <p class="login-subtitle">Fanisana Rakitra</p>
        
        <div class="login-box">
            <p style="text-align: center; margin-bottom: 1rem; color: var(--text-muted);">Ampidiro ny kaodin'acc√®s</p>
            <div class="pin-display">
                <div class="pin-dot" id="dot0"></div>
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
            </div>
            <div class="pin-keypad">
                <button class="pin-key" onclick="addPin('1')">1</button>
                <button class="pin-key" onclick="addPin('2')">2</button>
                <button class="pin-key" onclick="addPin('3')">3</button>
                <button class="pin-key" onclick="addPin('4')">4</button>
                <button class="pin-key" onclick="addPin('5')">5</button>
                <button class="pin-key" onclick="addPin('6')">6</button>
                <button class="pin-key" onclick="addPin('7')">7</button>
                <button class="pin-key" onclick="addPin('8')">8</button>
                <button class="pin-key" onclick="addPin('9')">9</button>
                <button class="pin-key danger" onclick="clearPin()">‚úï</button>
                <button class="pin-key" onclick="addPin('0')">0</button>
                <button class="pin-key success" onclick="submitPin()">‚úì</button>
            </div>
            <p id="loginError" class="login-error hidden"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>‚õ™ FJKM Freiburg</h1>
                    <p>Fanisana Rakitra</p>
                </div>
                <div class="header-user">
                    <span class="user-badge" id="userBadge">Mpanisa</span>
                    <button class="logout-btn" onclick="openChangeMyPinModal()" title="Hanova ny kaody">üîë</button>
                    <button class="logout-btn" onclick="logout()" title="Hivoaka">üö™</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs no-print">
            <button class="nav-tab active" data-tab="count">üí∂ Fanisana</button>
            <button class="nav-tab" data-tab="history">üìã Tantara</button>
            <button class="nav-tab" data-tab="admin" id="adminTab">‚öôÔ∏è Admin</button>
        </div>

        <div class="container">
            <!-- Counting Tab -->
            <div id="tab-count" class="tab-content active">
                <!-- Date and Category -->
                <div class="card">
                    <div class="card-header">üìÖ Fampahalalana</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Daty</label>
                            <input type="date" class="form-control" id="dateInput">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Sokajy (Karazana rakitra)</label>
                            <input type="text" class="form-control" id="categoryInput" placeholder="Ohatra: Rakitra I, Rakitra II...">
                        </div>
                    </div>
                </div>

                <!-- Bills -->
                <div class="card">
                    <div class="card-header">üí∂ Taratasy (Billets)</div>
                    <div class="card-body">
                        <div class="money-grid" id="billsGrid"></div>
                    </div>
                </div>

                <!-- Coins -->
                <div class="card">
                    <div class="card-header">ü™ô Vola madinika (Pi√®ces)</div>
                    <div class="card-body">
                        <div class="money-grid" id="coinsGrid"></div>
                    </div>
                </div>

                <!-- Total -->
                <div class="total-section">
                    <div class="total-label">TOTALIN'NY RAKITRA</div>
                    <div class="total-amount" id="grandTotal">0,00 ‚Ç¨</div>
                </div>

                <!-- Signatures -->
                <div class="card">
                    <div class="card-header">‚úçÔ∏è Sonia</div>
                    <div class="card-body">
                        <!-- Comptable 1 -->
                        <div class="signature-section">
                            <div class="form-group">
                                <label>Anaran'ny Mpanisa 1</label>
                                <input type="text" class="form-control" id="comptable1Name" placeholder="Anaran'ny mpanisa voalohany">
                            </div>
                            <div class="signature-header">
                                <span class="signature-name">Sonian'ny Mpanisa 1</span>
                                <button class="signature-clear" onclick="clearSignature('sig1')">üóëÔ∏è Fafao</button>
                            </div>
                            <canvas id="sig1" class="signature-pad"></canvas>
                        </div>

                        <!-- Comptable 2 -->
                        <div class="signature-section">
                            <div class="form-group">
                                <label>Anaran'ny Mpanisa 2</label>
                                <input type="text" class="form-control" id="comptable2Name" placeholder="Anaran'ny mpanisa faharoa">
                            </div>
                            <div class="signature-header">
                                <span class="signature-name">Sonian'ny Mpanisa 2</span>
                                <button class="signature-clear" onclick="clearSignature('sig2')">üóëÔ∏è Fafao</button>
                            </div>
                            <canvas id="sig2" class="signature-pad"></canvas>
                        </div>

                        <!-- Receiver -->
                        <div class="signature-section" style="margin-bottom: 0;">
                            <div class="form-group">
                                <label>Anaran'ny Mpandray vola</label>
                                <input type="text" class="form-control" id="receiverName" placeholder="Anaran'ny mpandray ny vola">
                            </div>
                            <div class="signature-header">
                                <span class="signature-name">Sonian'ny Mpandray vola</span>
                                <button class="signature-clear" onclick="clearSignature('sig3')">üóëÔ∏è Fafao</button>
                            </div>
                            <canvas id="sig3" class="signature-pad"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card no-print">
                    <div class="card-body">
                        <div class="btn-group" style="justify-content: center;">
                            <button class="btn btn-success" onclick="saveCollection()">üíæ Tehirizo</button>
                            <button class="btn btn-primary" onclick="saveAsPDF()">üìÑ PDF</button>
                            <button class="btn btn-danger" onclick="resetForm()">üîÑ Avereno</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <div class="card">
                    <div class="card-header">üìã Tantaran'ny Rakitra</div>
                    <div class="card-body">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content">
                <!-- Users Management -->
                <div class="card">
                    <div class="card-header">üë• Mpampiasa</div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-block" onclick="openAddUserModal()" style="margin-bottom: 1rem;">
                            + Hanampy mpampiasa vaovao
                        </button>
                        <div id="usersList"></div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-header success">üìä Statistika</div>
                    <div class="card-body">
                        <div id="statsContent"></div>
                    </div>
                </div>

                <!-- Export All -->
                <div class="card">
                    <div class="card-header warning">üì§ Export</div>
                    <div class="card-body">
                        <button class="btn btn-warning btn-block" onclick="exportAllHistory()">
                            üì• Tehirizo tantara rehetra (PDF)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ Mpampiasa vaovao</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>Anarana *</label>
                        <input type="text" class="form-control" id="newUserName" required placeholder="Anaran'ny mpampiasa">
                    </div>
                    <div class="form-group">
                        <label>Kaody PIN (4 chiffres) *</label>
                        <input type="text" class="form-control" id="newUserPin" required maxlength="4" pattern="[0-9]{4}" placeholder="0000" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Andraikitra</label>
                        <select class="form-control" id="newUserRole">
                            <option value="user">Mpanisa (User)</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">üíæ Tehirizo</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Collection Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìã Antsipirihan'ny Rakitra</h3>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚úèÔ∏è Hanova mpampiasa</h3>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>Anarana</label>
                        <input type="text" class="form-control" id="editUserName" required>
                    </div>
                    <div class="form-group">
                        <label>Kaody PIN vaovao (4 chiffres)</label>
                        <input type="text" class="form-control" id="editUserPin" maxlength="4" pattern="[0-9]{4}" placeholder="Aveao banga raha tsy ovaina" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Andraikitra</label>
                        <select class="form-control" id="editUserRole">
                            <option value="user">Mpanisa (User)</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">üíæ Tehirizo</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Change My PIN Modal -->
    <div class="modal-overlay" id="changeMyPinModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üîë Hanova ny kaody PIN</h3>
                <button class="modal-close" onclick="closeModal('changeMyPinModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changeMyPinForm">
                    <div class="form-group">
                        <label>Kaody PIN ankehitriny</label>
                        <input type="password" class="form-control" id="currentPin" required maxlength="4" pattern="[0-9]{4}" placeholder="****" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Kaody PIN vaovao (4 chiffres)</label>
                        <input type="text" class="form-control" id="newMyPin" required maxlength="4" pattern="[0-9]{4}" placeholder="0000" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Avereno ny kaody vaovao</label>
                        <input type="text" class="form-control" id="confirmMyPin" required maxlength="4" pattern="[0-9]{4}" placeholder="0000" inputmode="numeric">
                    </div>
                    <button type="submit" class="btn btn-success btn-block">üíæ Tehirizo</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ==================== DATA ====================
        const BILLS = [
            { value: 500, label: '500 ‚Ç¨' },
            { value: 200, label: '200 ‚Ç¨' },
            { value: 100, label: '100 ‚Ç¨' },
            { value: 50, label: '50 ‚Ç¨' },
            { value: 20, label: '20 ‚Ç¨' },
            { value: 10, label: '10 ‚Ç¨' },
            { value: 5, label: '5 ‚Ç¨' }
        ];

        const COINS = [
            { value: 2, label: '2 ‚Ç¨' },
            { value: 1, label: '1 ‚Ç¨' },
            { value: 0.50, label: '0,50 ‚Ç¨' },
            { value: 0.20, label: '0,20 ‚Ç¨' },
            { value: 0.10, label: '0,10 ‚Ç¨' },
            { value: 0.05, label: '0,05 ‚Ç¨' },
            { value: 0.02, label: '0,02 ‚Ç¨' },
            { value: 0.01, label: '0,01 ‚Ç¨' }
        ];

        // Default admin user
        const DEFAULT_USERS = [
            { id: 'admin1', name: 'Admin', pin: '1234', role: 'admin' }
        ];

        // ==================== STATE ====================
        let currentUser = null;
        let pinInput = '';
        let counts = {};
        let signatures = { sig1: null, sig2: null, sig3: null };

        // ==================== STORAGE ====================
        function getUsers() {
            const stored = localStorage.getItem('fjkm_rakitra_users');
            return stored ? JSON.parse(stored) : DEFAULT_USERS;
        }

        function saveUsers(users) {
            localStorage.setItem('fjkm_rakitra_users', JSON.stringify(users));
        }

        function getHistory() {
            const stored = localStorage.getItem('fjkm_rakitra_history');
            return stored ? JSON.parse(stored) : [];
        }

        function saveHistory(history) {
            localStorage.setItem('fjkm_rakitra_history', JSON.stringify(history));
        }

        // ==================== LOGIN ====================
        function addPin(digit) {
            if (pinInput.length < 4) {
                pinInput += digit;
                updatePinDisplay();
            }
        }

        function clearPin() {
            pinInput = '';
            updatePinDisplay();
            document.getElementById('loginError').classList.add('hidden');
        }

        function updatePinDisplay() {
            for (let i = 0; i < 4; i++) {
                const dot = document.getElementById(`dot${i}`);
                dot.classList.toggle('filled', i < pinInput.length);
            }
        }

        function submitPin() {
            if (pinInput.length !== 4) return;

            const users = getUsers();
            const user = users.find(u => u.pin === pinInput);

            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            } else {
                document.getElementById('loginError').textContent = '‚ùå Kaody tsy mety!';
                document.getElementById('loginError').classList.remove('hidden');
                pinInput = '';
                updatePinDisplay();
            }
        }

        function logout() {
            if (confirm('Hivoaka marina ve?')) {
                currentUser = null;
                pinInput = '';
                updatePinDisplay();
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        // ==================== APP INIT ====================
        function initApp() {
            // Update user badge
            const badge = document.getElementById('userBadge');
            badge.textContent = currentUser.name;
            badge.classList.toggle('admin', currentUser.role === 'admin');

            // Show/hide admin tab
            document.getElementById('adminTab').classList.toggle('hidden', currentUser.role !== 'admin');

            // Set today's date
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

            // Render money grids
            renderMoneyGrids();

            // Init signature pads
            initAllSignaturePads();

            // Setup tabs
            setupTabs();

            // Load data
            loadHistory();
            if (currentUser.role === 'admin') {
                loadUsers();
                loadStats();
            }
        }

        function renderMoneyGrids() {
            const billsGrid = document.getElementById('billsGrid');
            const coinsGrid = document.getElementById('coinsGrid');
            
            billsGrid.innerHTML = '';
            coinsGrid.innerHTML = '';

            BILLS.forEach(bill => {
                counts[bill.value] = 0;
                billsGrid.innerHTML += createMoneyRow(bill, 'bill');
            });

            COINS.forEach(coin => {
                counts[coin.value] = 0;
                coinsGrid.innerHTML += createMoneyRow(coin, 'coin');
            });

            // Add event listeners
            document.querySelectorAll('.money-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.dataset.value);
                    counts[value] = parseInt(e.target.value) || 0;
                    updateTotal(value);
                    calculateGrandTotal();
                });
            });
        }

        function createMoneyRow(item, type) {
            return `
                <div class="money-row">
                    <div class="money-label ${type}">${item.label}</div>
                    <input type="number" class="money-input" id="input_${item.value}" 
                           data-value="${item.value}" min="0" value="0" inputmode="numeric">
                    <div class="money-total" id="total_${item.value}">0,00 ‚Ç¨</div>
                </div>
            `;
        }

        function updateTotal(value) {
            const count = counts[value] || 0;
            const total = count * value;
            document.getElementById(`total_${value}`).textContent = formatCurrency(total);
        }

        function calculateGrandTotal() {
            let total = 0;
            Object.keys(counts).forEach(value => {
                total += counts[value] * parseFloat(value);
            });
            document.getElementById('grandTotal').textContent = formatCurrency(total);
            return total;
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // ==================== TABS ====================
        function setupTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tabName}`).classList.add('active');

                    if (tabName === 'history') loadHistory();
                    if (tabName === 'admin' && currentUser.role === 'admin') {
                        loadUsers();
                        loadStats();
                    }
                });
            });
        }

        // ==================== SIGNATURE PADS ====================
        function initAllSignaturePads() {
            ['sig1', 'sig2', 'sig3'].forEach(id => {
                initSignaturePad(id);
            });
        }

        function initSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 80;

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                }
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#1a365d';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.stroke();
                
                lastX = pos.x;
                lastY = pos.y;
                
                canvas.classList.add('signed');
                signatures[canvasId] = canvas.toDataURL();
            }

            function stopDrawing() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.classList.remove('signed');
            signatures[canvasId] = null;
        }

        // ==================== SAVE COLLECTION ====================
        function saveCollection() {
            const date = document.getElementById('dateInput').value;
            const category = document.getElementById('categoryInput').value || 'Tsy voafaritra';
            const comptable1 = document.getElementById('comptable1Name').value || '-';
            const comptable2 = document.getElementById('comptable2Name').value || '-';
            const receiver = document.getElementById('receiverName').value || '-';
            const total = calculateGrandTotal();

            if (total === 0) {
                showToast('Tsy misy vola voaisa!', 'error');
                return;
            }

            // Build details
            const details = {};
            [...BILLS, ...COINS].forEach(item => {
                if (counts[item.value] > 0) {
                    details[item.value] = {
                        count: counts[item.value],
                        subtotal: counts[item.value] * item.value
                    };
                }
            });

            const collection = {
                id: Date.now().toString(),
                date,
                category,
                total,
                details,
                comptable1,
                comptable2,
                receiver,
                signatures: { ...signatures },
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };

            const history = getHistory();
            history.unshift(collection);
            saveHistory(history);

            showToast('Rakitra voatahiry!', 'success');
            loadHistory();
        }

        // ==================== HISTORY ====================
        function loadHistory() {
            const history = getHistory();
            const container = document.getElementById('historyList');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Tsy mbola misy rakitra voatahiry</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item" onclick="showDetail('${item.id}')">
                    <div class="history-header">
                        <div>
                            <div class="history-date">${formatDate(item.date)}</div>
                            <div class="history-category">${item.category}</div>
                        </div>
                        <div class="history-amount">${formatCurrency(item.total)}</div>
                    </div>
                    <div class="history-people">
                        üë• ${item.comptable1}, ${item.comptable2} ‚Üí ${item.receiver}
                    </div>
                </div>
            `).join('');
        }

        function showDetail(id) {
            const history = getHistory();
            const item = history.find(h => h.id === id);
            if (!item) return;

            let detailsHtml = '';
            if (item.details) {
                detailsHtml = '<h4 style="margin: 1rem 0 0.5rem;">üí∂ Antsipiriany:</h4>';
                Object.keys(item.details).forEach(value => {
                    const d = item.details[value];
                    const label = parseFloat(value) >= 5 ? `${value} ‚Ç¨` : `${parseFloat(value).toFixed(2).replace('.', ',')} ‚Ç¨`;
                    detailsHtml += `<div class="detail-row"><span>${label} √ó ${d.count}</span><span class="detail-value">${formatCurrency(d.subtotal)}</span></div>`;
                });
            }

            let signaturesHtml = '<h4 style="margin: 1rem 0 0.5rem;">‚úçÔ∏è Sonia:</h4>';
            if (item.signatures) {
                if (item.signatures.sig1) {
                    signaturesHtml += `<div><strong>${item.comptable1}</strong><div class="signature-preview"><img src="${item.signatures.sig1}" alt="Signature"></div></div>`;
                }
                if (item.signatures.sig2) {
                    signaturesHtml += `<div><strong>${item.comptable2}</strong><div class="signature-preview"><img src="${item.signatures.sig2}" alt="Signature"></div></div>`;
                }
                if (item.signatures.sig3) {
                    signaturesHtml += `<div><strong>${item.receiver}</strong><div class="signature-preview"><img src="${item.signatures.sig3}" alt="Signature"></div></div>`;
                }
            }

            document.getElementById('detailContent').innerHTML = `
                <div class="detail-row"><span class="detail-label">Daty</span><span class="detail-value">${formatDate(item.date)}</span></div>
                <div class="detail-row"><span class="detail-label">Sokajy</span><span class="detail-value">${item.category}</span></div>
                <div class="detail-row"><span class="detail-label">Mpanisa 1</span><span class="detail-value">${item.comptable1}</span></div>
                <div class="detail-row"><span class="detail-label">Mpanisa 2</span><span class="detail-value">${item.comptable2}</span></div>
                <div class="detail-row"><span class="detail-label">Mpandray</span><span class="detail-value">${item.receiver}</span></div>
                <div class="detail-row" style="background: var(--success); color: white; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <span>TOTALY</span><span style="font-size: 1.3rem; font-weight: 700;">${formatCurrency(item.total)}</span>
                </div>
                ${detailsHtml}
                ${signaturesHtml}
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary btn-block" onclick="downloadPDF('${item.id}')">üìÑ Tehirizo PDF</button>
                    ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-block" style="margin-top: 0.5rem;" onclick="deleteCollection('${item.id}')">üóëÔ∏è Fafao</button>` : ''}
                </div>
            `;

            openModal('detailModal');
        }

        function deleteCollection(id) {
            if (!confirm('Hamafa ity rakitra ity?')) return;
            
            let history = getHistory();
            history = history.filter(h => h.id !== id);
            saveHistory(history);
            
            closeModal('detailModal');
            loadHistory();
            showToast('Rakitra voafafa', 'success');
        }

        // ==================== USERS MANAGEMENT ====================
        function loadUsers() {
            const users = getUsers();
            const container = document.getElementById('usersList');

            container.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <span>${user.name}</span>
                        <span class="user-role ${user.role}">${user.role === 'admin' ? 'Admin' : 'Mpanisa'}</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="openEditUserModal('${user.id}')" title="Hanova">‚úèÔ∏è</button>
                        ${user.id !== 'admin1' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')" title="Hamafa">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openEditUserModal(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserPin').value = '';
            document.getElementById('editUserRole').value = user.role;
            
            openModal('editUserModal');
        }

        document.getElementById('editUserForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const newPin = document.getElementById('editUserPin').value;
            const role = document.getElementById('editUserRole').value;

            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;

            // Update name and role
            users[userIndex].name = name;
            users[userIndex].role = role;

            // Update PIN only if provided
            if (newPin) {
                if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                    showToast('Kaody PIN dia 4 chiffres!', 'error');
                    return;
                }
                
                // Check if PIN already exists for another user
                if (users.find(u => u.pin === newPin && u.id !== userId)) {
                    showToast('Efa misy io kaody io!', 'error');
                    return;
                }
                
                users[userIndex].pin = newPin;
            }

            saveUsers(users);
            closeModal('editUserModal');
            loadUsers();
            showToast(`Mpampiasa "${name}" voaova!`, 'success');

            // Update current user badge if editing self
            if (userId === currentUser.id) {
                currentUser = users[userIndex];
                document.getElementById('userBadge').textContent = currentUser.name;
            }
        });

        // ==================== CHANGE MY PIN ====================
        function openChangeMyPinModal() {
            document.getElementById('changeMyPinForm').reset();
            openModal('changeMyPinModal');
        }

        document.getElementById('changeMyPinForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPinInput = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newMyPin').value;
            const confirmPin = document.getElementById('confirmMyPin').value;

            // Verify current PIN
            if (currentPinInput !== currentUser.pin) {
                showToast('Kaody ankehitriny tsy mety!', 'error');
                return;
            }

            // Validate new PIN
            if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                showToast('Kaody PIN vaovao dia 4 chiffres!', 'error');
                return;
            }

            // Confirm match
            if (newPin !== confirmPin) {
                showToast('Kaody vaovao tsy mitovy!', 'error');
                return;
            }

            // Check if PIN already exists for another user
            const users = getUsers();
            if (users.find(u => u.pin === newPin && u.id !== currentUser.id)) {
                showToast('Efa misy io kaody io!', 'error');
                return;
            }

            // Update PIN
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].pin = newPin;
                currentUser.pin = newPin;
                saveUsers(users);
                closeModal('changeMyPinModal');
                showToast('Kaody PIN voaova!', 'success');
            }
        });

        function openAddUserModal() {
            document.getElementById('addUserForm').reset();
            openModal('addUserModal');
        }

        document.getElementById('addUserForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value.trim();
            const pin = document.getElementById('newUserPin').value;
            const role = document.getElementById('newUserRole').value;

            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast('Kaody PIN dia 4 chiffres!', 'error');
                return;
            }

            const users = getUsers();
            
            if (users.find(u => u.pin === pin)) {
                showToast('Efa misy io kaody io!', 'error');
                return;
            }

            users.push({
                id: 'user_' + Date.now(),
                name,
                pin,
                role
            });

            saveUsers(users);
            closeModal('addUserModal');
            loadUsers();
            showToast(`Mpampiasa "${name}" voaforona!`, 'success');
        });

        function deleteUser(id) {
            if (!confirm('Hamafa ity mpampiasa ity?')) return;
            
            let users = getUsers();
            users = users.filter(u => u.id !== id);
            saveUsers(users);
            loadUsers();
            showToast('Mpampiasa voafafa', 'success');
        }

        // ==================== STATISTICS ====================
        function loadStats() {
            const history = getHistory();
            
            if (history.length === 0) {
                document.getElementById('statsContent').innerHTML = '<p style="color: var(--text-muted);">Tsy misy donn√©es</p>';
                return;
            }

            const totalAll = history.reduce((sum, h) => sum + h.total, 0);
            const avgCollection = totalAll / history.length;

            // Group by month
            const byMonth = {};
            history.forEach(h => {
                const month = h.date.substring(0, 7);
                byMonth[month] = (byMonth[month] || 0) + h.total;
            });

            document.getElementById('statsContent').innerHTML = `
                <div class="detail-row"><span class="detail-label">Isan'ny rakitra</span><span class="detail-value">${history.length}</span></div>
                <div class="detail-row"><span class="detail-label">Totalin'ny rehetra</span><span class="detail-value" style="color: var(--success);">${formatCurrency(totalAll)}</span></div>
                <div class="detail-row"><span class="detail-label">Salan'isa</span><span class="detail-value">${formatCurrency(avgCollection)}</span></div>
                <h4 style="margin: 1rem 0 0.5rem;">üìÖ Isam-bolana:</h4>
                ${Object.keys(byMonth).sort().reverse().slice(0, 6).map(month => `
                    <div class="detail-row"><span>${month}</span><span class="detail-value">${formatCurrency(byMonth[month])}</span></div>
                `).join('')}
            `;
        }

        // ==================== PDF ====================
        function saveAsPDF() {
            const total = calculateGrandTotal();
            if (total === 0) {
                showToast('Tsy misy vola voaisa!', 'error');
                return;
            }
            generatePDF(null);
        }

        function downloadPDF(id) {
            generatePDF(id);
        }

        function generatePDF(collectionId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let data;
            if (collectionId) {
                const history = getHistory();
                data = history.find(h => h.id === collectionId);
            } else {
                data = {
                    date: document.getElementById('dateInput').value,
                    category: document.getElementById('categoryInput').value || 'Tsy voafaritra',
                    comptable1: document.getElementById('comptable1Name').value || '-',
                    comptable2: document.getElementById('comptable2Name').value || '-',
                    receiver: document.getElementById('receiverName').value || '-',
                    total: calculateGrandTotal(),
                    signatures
                };
            }

            // Title
            doc.setFontSize(18);
            doc.setTextColor(26, 54, 93);
            doc.text('FJKM Freiburg Fiderana', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Fanisana Rakitra', 105, 28, { align: 'center' });

            // Info
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Daty: ${formatDate(data.date)}`, 20, 45);
            doc.text(`Sokajy: ${data.category}`, 20, 53);

            // Details
            let y = 65;
            doc.setFontSize(12);
            doc.setTextColor(26, 54, 93);
            doc.text('Vola voaisana:', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            if (collectionId && data.details) {
                Object.keys(data.details).forEach(value => {
                    const d = data.details[value];
                    const label = parseFloat(value) >= 5 ? `${value} ‚Ç¨` : `${parseFloat(value).toFixed(2).replace('.', ',')} ‚Ç¨`;
                    doc.text(`${label} x ${d.count} = ${formatCurrency(d.subtotal)}`, 25, y);
                    y += 6;
                });
            } else {
                [...BILLS, ...COINS].forEach(item => {
                    const count = counts[item.value] || 0;
                    if (count > 0) {
                        const total = count * item.value;
                        doc.text(`${item.label} x ${count} = ${formatCurrency(total)}`, 25, y);
                        y += 6;
                    }
                });
            }

            // Total
            y += 5;
            doc.setFontSize(14);
            doc.setTextColor(26, 54, 93);
            doc.text(`TOTALY: ${formatCurrency(data.total)}`, 20, y);

            // Signatures
            y += 20;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            const sigs = data.signatures || signatures;

            doc.text(`Mpanisa 1: ${data.comptable1}`, 20, y);
            if (sigs.sig1) doc.addImage(sigs.sig1, 'PNG', 20, y + 2, 50, 15);
            doc.line(20, y + 20, 70, y + 20);

            doc.text(`Mpanisa 2: ${data.comptable2}`, 80, y);
            if (sigs.sig2) doc.addImage(sigs.sig2, 'PNG', 80, y + 2, 50, 15);
            doc.line(80, y + 20, 130, y + 20);

            doc.text(`Mpandray: ${data.receiver}`, 140, y);
            if (sigs.sig3) doc.addImage(sigs.sig3, 'PNG', 140, y + 2, 50, 15);
            doc.line(140, y + 20, 190, y + 20);

            const filename = `Rakitra-${data.date}-${data.category.replace(/\s+/g, '-')}.pdf`;
            doc.save(filename);
            showToast('PDF voatahiry!', 'success');
        }

        function exportAllHistory() {
            const history = getHistory();
            if (history.length === 0) {
                showToast('Tsy misy tantara!', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.setTextColor(26, 54, 93);
            doc.text('FJKM Freiburg Fiderana', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Tantaran\'ny Rakitra Rehetra', 105, 28, { align: 'center' });

            let y = 45;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            const totalAll = history.reduce((sum, h) => sum + h.total, 0);

            doc.setFontSize(12);
            doc.text(`Isan'ny rakitra: ${history.length}`, 20, y);
            doc.text(`Totalin'ny rehetra: ${formatCurrency(totalAll)}`, 100, y);
            y += 15;

            doc.setFontSize(9);
            history.forEach((item, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${index + 1}. ${item.date} | ${item.category} | ${formatCurrency(item.total)} | ${item.comptable1}, ${item.comptable2}`, 20, y);
                y += 6;
            });

            doc.save('FJKM-Rakitra-Tantara-Rehetra.pdf');
            showToast('PDF voatahiry!', 'success');
        }

        // ==================== RESET ====================
        function resetForm() {
            if (!confirm('Hamafa ny zavatra rehetra?')) return;

            Object.keys(counts).forEach(value => {
                counts[value] = 0;
                const input = document.getElementById(`input_${value}`);
                const total = document.getElementById(`total_${value}`);
                if (input) input.value = 0;
                if (total) total.textContent = '0,00 ‚Ç¨';
            });

            document.getElementById('grandTotal').textContent = '0,00 ‚Ç¨';
            document.getElementById('categoryInput').value = '';
            document.getElementById('comptable1Name').value = '';
            document.getElementById('comptable2Name').value = '';
            document.getElementById('receiverName').value = '';

            clearSignature('sig1');
            clearSignature('sig2');
            clearSignature('sig3');

            showToast('Voafafa daholo!', 'success');
        }

        // ==================== MODALS ====================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ==================== TOAST ====================
        function showToast(message, type = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
