import React, { useState, useEffect } from 'react';
import { Calendar, Users, Save, History, Download, Trash2 } from 'lucide-react';

const AppQueteFJKM = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loginCode, setLoginCode] = useState('');
  const [currentTab, setCurrentTab] = useState('decompte');
  const [historique, setHistorique] = useState([]);
  
  // Code d'acc√®s (√† changer pour votre propre code)
  const ACCESS_CODE = '2024FJKM';
  
  const denominations = [
    { value: 500, label: '500 ‚Ç¨', color: '#9C27B0' },
    { value: 200, label: '200 ‚Ç¨', color: '#FFB300' },
    { value: 100, label: '100 ‚Ç¨', color: '#4CAF50' },
    { value: 50, label: '50 ‚Ç¨', color: '#FF9800' },
    { value: 20, label: '20 ‚Ç¨', color: '#2196F3' },
    { value: 10, label: '10 ‚Ç¨', color: '#F44336' },
    { value: 5, label: '5 ‚Ç¨', color: '#9E9E9E' },
    { value: 2, label: '2 ‚Ç¨', color: '#795548' },
    { value: 1, label: '1 ‚Ç¨', color: '#607D8B' },
    { value: 0.50, label: '0.50 ‚Ç¨', color: '#FFC107' },
    { value: 0.20, label: '0.20 ‚Ç¨', color: '#FF5722' },
    { value: 0.10, label: '0.10 ‚Ç¨', color: '#00BCD4' },
    { value: 0.05, label: '0.05 ‚Ç¨', color: '#8BC34A' },
    { value: 0.02, label: '0.02 ‚Ç¨', color: '#CDDC39' },
    { value: 0.01, label: '0.01 ‚Ç¨', color: '#FDD835' }
  ];

  const categories = [
    'Rakitra 1',
    'Rakitra 2',
    'Rakitra Fandraisana',
    'Rakitra manokana',
    'Adidy Mpandray'
  ];

  const [decompte, setDecompte] = useState(
    denominations.reduce((acc, d) => ({ ...acc, [d.value]: 0 }), {})
  );

  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    compteur1: '',
    compteur2: '',
    recepteur: '',
    categorie: '',
    commentaire: ''
  });

  useEffect(() => {
    const savedAuth = localStorage.getItem('fjkm_quete_auth');
    if (savedAuth === ACCESS_CODE) {
      setIsAuthenticated(true);
    }
    
    const saved = localStorage.getItem('fjkm_historique_quete');
    if (saved) {
      setHistorique(JSON.parse(saved));
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('fjkm_historique_quete', JSON.stringify(historique));
  }, [historique]);

  const calculateTotal = () => {
    return denominations.reduce((sum, d) => sum + (d.value * (decompte[d.value] || 0)), 0);
  };

  const handleLogin = () => {
    if (loginCode === ACCESS_CODE) {
      setIsAuthenticated(true);
      localStorage.setItem('fjkm_quete_auth', ACCESS_CODE);
    } else {
      alert('Code d\'acc√®s incorrect');
      setLoginCode('');
    }
  };

  const handleLogout = () => {
    setIsAuthenticated(false);
    localStorage.removeItem('fjkm_quete_auth');
    setLoginCode('');
  };

  const resetForm = () => {
    setDecompte(denominations.reduce((acc, d) => ({ ...acc, [d.value]: 0 }), {}));
    setFormData({
      date: new Date().toISOString().split('T')[0],
      compteur1: '',
      compteur2: '',
      recepteur: '',
      categorie: '',
      commentaire: ''
    });
  };

  const saveDecompte = () => {
    if (!formData.compteur1 || !formData.compteur2 || !formData.recepteur || !formData.categorie) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }

    const total = calculateTotal();
    if (total === 0) {
      alert('Le total est 0 ‚Ç¨. Veuillez entrer des montants.');
      return;
    }

    const newEntry = {
      id: Date.now(),
      ...formData,
      decompte: {...decompte},
      total: total,
      timestamp: new Date().toISOString()
    };

    setHistorique([newEntry, ...historique]);
    alert('D√©compte enregistr√© avec succ√®s !');
    resetForm();
  };

  const deleteEntry = (id) => {
    if (window.confirm('Supprimer ce d√©compte ?')) {
      setHistorique(historique.filter(h => h.id !== id));
    }
  };

  const generatePDFContent = (entry) => {
    const date = new Date(entry.date).toLocaleDateString('fr-FR');
    let content = `D√âCOMPTE DE QU√äTE - FJKM FREIBURG\n`;
    content += `${'='.repeat(50)}\n\n`;
    content += `Date: ${date}\n`;
    content += `Cat√©gorie: ${entry.categorie}\n\n`;
    content += `Compteurs:\n`;
    content += `  - ${entry.compteur1}\n`;
    content += `  - ${entry.compteur2}\n\n`;
    content += `R√©cepteur: ${entry.recepteur}\n\n`;
    content += `${'-'.repeat(50)}\n`;
    content += `D√âTAIL DES BILLETS ET PI√àCES\n`;
    content += `${'-'.repeat(50)}\n\n`;
    
    denominations.forEach(d => {
      if (entry.decompte[d.value] > 0) {
        const subtotal = d.value * entry.decompte[d.value];
        content += `${d.label.padEnd(10)} √ó ${String(entry.decompte[d.value]).padStart(3)} = ${subtotal.toFixed(2).padStart(10)} ‚Ç¨\n`;
      }
    });
    
    content += `\n${'='.repeat(50)}\n`;
    content += `TOTAL: ${entry.total.toFixed(2)} ‚Ç¨\n`;
    content += `${'='.repeat(50)}\n\n`;
    
    if (entry.commentaire) {
      content += `Commentaire:\n${entry.commentaire}\n\n`;
    }
    
    content += `Enregistr√© le: ${new Date(entry.timestamp).toLocaleString('fr-FR')}\n`;
    
    return content;
  };

  const downloadPDF = (entry) => {
    const date = new Date(entry.date).toLocaleDateString('fr-FR');
    const content = generatePDFContent(entry);
    
    const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `quete_${entry.categorie.replace(/\s+/g, '_')}_${date.replace(/\//g, '-')}.txt`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const sendByEmail = (entry) => {
    const date = new Date(entry.date).toLocaleDateString('fr-FR');
    const content = generatePDFContent(entry);
    
    const subject = `D√©compte Qu√™te - ${entry.categorie} - ${date}`;
    const body = encodeURIComponent(content);
    
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
  };

  const filteredHistorique = historique;

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 to-purple-900 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
          <div className="text-center mb-6">
            <div className="text-6xl mb-4">üôè</div>
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Fanisana Rakitra</h1>
            <p className="text-gray-600">FJKM Freiburg Fiderana</p>
          </div>
          
          <div className="mb-6">
            <label className="block text-sm font-semibold mb-2 text-gray-700">Code d'acc√®s</label>
            <input
              type="password"
              value={loginCode}
              onChange={(e) => setLoginCode(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
              placeholder="Entrez le code"
              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-center text-lg"
            />
          </div>
          
          <button
            onClick={handleLogin}
            className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold text-lg shadow-md"
          >
            Se connecter
          </button>
          
          <div className="mt-6 text-center">
            <p className="text-xs text-gray-500">
              üîí Acc√®s r√©serv√© aux membres autoris√©s
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-4 shadow-lg">
        <div className="flex justify-between items-center">
          <div className="flex-1">
            <h1 className="text-2xl font-bold text-center">üôè Fanisana Rakitra</h1>
            <p className="text-center text-purple-100 text-sm mt-1">FJKM Freiburg Fiderana</p>
          </div>
          <button
            onClick={handleLogout}
            className="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-semibold"
          >
            üö™ Sortir
          </button>
        </div>
      </div>

      <div className="flex border-b bg-white">
        <button
          onClick={() => setCurrentTab('decompte')}
          className={`flex-1 py-3 font-semibold ${currentTab === 'decompte' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-500'}`}
        >
          üí∂ D√©compte
        </button>
        <button
          onClick={() => setCurrentTab('historique')}
          className={`flex-1 py-3 font-semibold ${currentTab === 'historique' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-500'}`}
        >
          üìã Historique
        </button>
      </div>

      {currentTab === 'decompte' && (
        <div className="p-4 max-w-2xl mx-auto">
          <div className="bg-white rounded-lg shadow-md p-6 mb-4">
            <h2 className="text-lg font-bold mb-4 text-gray-800">üìÖ Informations</h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">Date</label>
                <div className="relative">
                  <Calendar className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
                  <input
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData({...formData, date: e.target.value})}
                    className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">Cat√©gorie *</label>
                <select
                  value={formData.categorie}
                  onChange={(e) => setFormData({...formData, categorie: e.target.value})}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                >
                  <option value="">S√©lectionner une cat√©gorie</option>
                  {categories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">Compteur 1 *</label>
                <div className="relative">
                  <Users className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
                  <input
                    type="text"
                    value={formData.compteur1}
                    onChange={(e) => setFormData({...formData, compteur1: e.target.value})}
                    placeholder="Nom de la premi√®re personne"
                    className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">Compteur 2 *</label>
                <div className="relative">
                  <Users className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
                  <input
                    type="text"
                    value={formData.compteur2}
                    onChange={(e) => setFormData({...formData, compteur2: e.target.value})}
                    placeholder="Nom de la deuxi√®me personne"
                    className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">R√©cepteur *</label>
                <input
                  type="text"
                  value={formData.recepteur}
                  onChange={(e) => setFormData({...formData, recepteur: e.target.value})}
                  placeholder="Nom de la personne qui re√ßoit l'argent"
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2 text-gray-700">Commentaire</label>
                <textarea
                  value={formData.commentaire}
                  onChange={(e) => setFormData({...formData, commentaire: e.target.value})}
                  placeholder="Notes ou observations..."
                  rows="3"
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                />
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6 mb-4">
            <h2 className="text-lg font-bold mb-4 text-gray-800">üí∞ D√©compte des Billets et Pi√®ces</h2>
            
            <div className="space-y-2">
              {denominations.map(d => (
                <div key={d.value} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div className="flex items-center gap-3">
                    <div 
                      className="w-3 h-3 rounded-full"
                      style={{backgroundColor: d.color}}
                    />
                    <span className="font-bold text-gray-800 w-20">{d.label}</span>
                  </div>
                  <div className="flex items-center gap-3">
                    <input
                      type="number"
                      min="0"
                      value={decompte[d.value]}
                      onChange={(e) => setDecompte({...decompte, [d.value]: parseInt(e.target.value) || 0})}
                      className="w-20 px-3 py-2 border rounded-lg text-right focus:ring-2 focus:ring-purple-500"
                    />
                    <span className="text-gray-600 w-24 text-right font-semibold">
                      {(d.value * (decompte[d.value] || 0)).toFixed(2)} ‚Ç¨
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg shadow-lg p-6 mb-4">
            <div className="text-center">
              <div className="text-sm font-semibold mb-2">TOTAL</div>
              <div className="text-4xl font-bold">{calculateTotal().toFixed(2)} ‚Ç¨</div>
            </div>
          </div>

          <div className="flex gap-3">
            <button
              onClick={saveDecompte}
              className="flex-1 flex items-center justify-center gap-2 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold shadow-md"
            >
              <Save size={20} /> Enregistrer
            </button>
            <button
              onClick={resetForm}
              className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-semibold"
            >
              R√©initialiser
            </button>
          </div>
        </div>
      )}

      {currentTab === 'historique' && (
        <div className="p-4">
          <div className="max-w-4xl mx-auto">
            <div className="mb-4">
              <h2 className="text-xl font-bold text-gray-800">üìã Historique des D√©comptes</h2>
              <p className="text-sm text-gray-600">{historique.length} d√©compte(s) enregistr√©(s)</p>
            </div>

            {historique.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <History size={48} className="mx-auto mb-4 text-gray-300" />
                <p className="text-lg">Aucun d√©compte enregistr√©</p>
                <p className="text-sm">Les d√©comptes appara√Ætront ici apr√®s enregistrement</p>
              </div>
            ) : (
              <div className="space-y-4">
                {filteredHistorique.map(entry => (
                  <div key={entry.id} className="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
                            {entry.categorie}
                          </span>
                          <span className="text-sm text-gray-500">
                            {new Date(entry.date).toLocaleDateString('fr-FR')}
                          </span>
                        </div>
                        
                        <div className="text-sm text-gray-700 space-y-1 mb-2">
                          <div><span className="font-semibold">Compteurs:</span> {entry.compteur1}, {entry.compteur2}</div>
                          <div><span className="font-semibold">R√©cepteur:</span> {entry.recepteur}</div>
                        </div>

                        {entry.commentaire && (
                          <div className="text-sm text-gray-600 bg-gray-50 p-2 rounded mt-2">
                            üí¨ {entry.commentaire}
                          </div>
                        )}
                      </div>
                      
                      <div className="text-right ml-4">
                        <div className="text-2xl font-bold text-purple-600 mb-2">
                          {entry.total.toFixed(2)} ‚Ç¨
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => downloadPDF(entry)}
                            className="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"
                            title="T√©l√©charger"
                          >
                            <Download size={16} />
                          </button>
                          <button
                            onClick={() => sendByEmail(entry)}
                            className="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200"
                            title="Envoyer par email"
                          >
                            üìß
                          </button>
                          <button
                            onClick={() => deleteEntry(entry.id)}
                            className="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200"
                            title="Supprimer"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    </div>

                    <details className="mt-3">
                      <summary className="cursor-pointer text-sm text-purple-600 font-semibold hover:text-purple-700">
                        Voir le d√©tail du d√©compte
                      </summary>
                      <div className="mt-2 grid grid-cols-2 gap-2 text-xs">
                        {denominations.filter(d => entry.decompte[d.value] > 0).map(d => (
                          <div key={d.value} className="flex justify-between bg-gray-50 p-2 rounded">
                            <span>{d.label} √ó {entry.decompte[d.value]}</span>
                            <span className="font-semibold">{(d.value * entry.decompte[d.value]).toFixed(2)} ‚Ç¨</span>
                          </div>
                        ))}
                      </div>
                    </details>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default AppQueteFJKM;